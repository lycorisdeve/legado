name: Sync Upstream Releases Only

on:
  schedule:
    - cron: '0 3 * * *'    # 每天凌晨3点执行一次
  workflow_dispatch:

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}   # 你需要在仓库 Secrets 里配置 GH_TOKEN，值为 PAT

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: List upstream releases
        run: |
          gh release list --repo gedoor/legado --limit 1000 > upstream.txt
          gh release list --limit 1000 > my.txt

      - name: Find new releases
        id: find_new
        run: |
          cut -f1 -d$'\t' upstream.txt | sort > upstream_tags.txt
          cut -f1 -d$'\t' my.txt | sort > my_tags.txt
          comm -23 upstream_tags.txt my_tags.txt | grep -vE '^\s*$|^-$' > new_releases.txt
          new_releases=$(paste -sd ',' new_releases.txt)
          echo "new_releases=$new_releases" >> $GITHUB_OUTPUT
          echo "New releases to sync:"
          cat new_releases.txt || echo "(none)"

      - name: Sync new releases
        if: steps.find_new.outputs.new_releases != ''
        run: |
          while IFS= read -r tag; do
            echo "Sync release $tag"
            if ! release_json=$(gh release view "$tag" --repo gedoor/legado --json name,body,isDraft,isPrerelease); then
              echo "⚠️ Release $tag 不存在或访问失败，跳过"
              continue
            fi

            name=$(echo "$release_json" | jq -r '.name')
            body=$(echo "$release_json" | jq -r '.body')
            draft=$(echo "$release_json" | jq -r '.isDraft')
            prerelease=$(echo "$release_json" | jq -r '.isPrerelease')

            mkdir -p downloads
            gh release download "$tag" --repo gedoor/legado --dir downloads || echo "No assets"

            if [ "$(ls -A downloads)" ]; then
              gh release create "$tag" downloads/* --repo $GITHUB_REPOSITORY --title "$name" --notes "$body" $( [ "$draft" = "true" ] && echo "--draft" ) $( [ "$prerelease" = "true" ] && echo "--prerelease" )
            else
              gh release create "$tag" --repo $GITHUB_REPOSITORY --title "$name" --notes "$body" $( [ "$draft" = "true" ] && echo "--draft" ) $( [ "$prerelease" = "true" ] && echo "--prerelease" )
            fi

            rm -rf downloads
            echo "Release $tag synced"
          done < new_releases.txt

      - name: Finish
        run: echo "Releases sync complete"
